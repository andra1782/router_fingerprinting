"""
Run only once if needed to create the database. You need to have `cvelistV5-main` in the same folder as this script.
Note that you need to manually update the db schema and create the indexes after this script runs.
"""
import pandas as pd
from pathlib import Path
import sqlite3
import json

con = sqlite3.connect('cve.db')

def read_json_to_dataframe(file_path: str) -> pd.DataFrame:
    try:
        if not Path(file_path).exists():
            raise FileNotFoundError(f"JSON file not found: {file_path}")
        return pd.read_json(file_path)
    except Exception as e:
        print(f"Error reading JSON file: {e}")
        return pd.DataFrame()
    
    
def save_to_sqlite(json_list: list[dict]):
    df = pd.DataFrame.from_dict(json_list)
    df = df.set_index('cveId')
    print(df.to_sql(name='cve_metadata', con=con, if_exists='replace'))
        
        
def read_metadata(filename: str) -> dict:
    with open(filename, 'r', encoding='utf-8') as f:
        data = json.load(f)
        return data['cveMetadata']


if __name__ == '__main__':
    metadata_list = []
    
    with open('hitlist.txt', 'r') as hitlist:
        for line in hitlist:
            print(line.strip())
            metadata_list.append(read_metadata(line.strip()))
    
    save_to_sqlite(metadata_list)
