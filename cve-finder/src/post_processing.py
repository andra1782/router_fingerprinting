import pandas as pd
import seaborn as sns
from matplotlib import pyplot as plt, rcParams
from matplotlib.axes import Axes
from matplotlib.pyplot import title

sns.set_theme(style="ticks")


rcParams['figure.figsize'] = 11.76,4.85 # powerpoint graph size


def apply_style(*, xlabel, ylabel, title):
    def plot_fun(fun):
        def take_args(*args, **kwargs):
            ax = fun(*args, **kwargs)

            ax.set(xlabel=xlabel, ylabel=ylabel)
            ax.set(yscale='log')
            ax.set_title(title)

            try:
                sns.move_legend(ax,  loc='upper center', ncol=4)
            except Exception:
                pass
            
            plt.show()
            
        return take_args
    return plot_fun


@apply_style(xlabel='CVSS Base Score', ylabel='Number of CVEs', title='CVSS Base Score Distribution')
def basic_plot(df: pd.DataFrame) -> Axes:
    df = df[['shortVendorName', 'baseScore']]
    return sns.histplot(data=df, x='baseScore', hue='shortVendorName', multiple='dodge',
                        binwidth=.5, palette='Paired', linewidth=.5)


@apply_style(xlabel='Severity Level', ylabel='Percentage of CVEs', title='CVE Severity Distribution')
def string_plot(df: pd.DataFrame) -> Axes:
    df = df[['shortVendorName', 'baseSeverity']].sort_values('baseSeverity')
    return sns.histplot(data=df, x='baseSeverity', hue='shortVendorName', multiple='fill',
                        palette='Paired', linewidth=.5)


@apply_style(xlabel='Vendors', ylabel='Number of IPs', title='IPs per Vendor')
def ips_per_vendor(df: pd.DataFrame) -> Axes:
    df = df[['shortVendorName', 'ip']].drop_duplicates().groupby(['shortVendorName']).count()
    return sns.barplot(data=df, x='shortVendorName', y='ip', hue='shortVendorName', palette='Paired', linewidth=.5,)


def print_metrics(df: pd.DataFrame):
    print(df[['shortVendorName', 'baseScore']].groupby(['shortVendorName']).mean().sort_values('baseScore', ascending=False))


if __name__ == '__main__':
    df = pd.read_csv('../found_cves.csv')
    # print(df['shortVendorName'].drop_duplicates())
    basic_plot(df)
    string_plot(df)
    ips_per_vendor(df)
    # print_metrics(df)
