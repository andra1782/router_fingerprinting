import json
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin


def fetch_vendor_info(pen_number):
    base_url = "https://www.iana.org/assignments/enterprise-numbers/"
    params = {'q': str(pen_number)}

    try:
        response = requests.get(urljoin(base_url, ''), params=params)
        response.raise_for_status()

        soup = BeautifulSoup(response.text, 'html.parser')
        vendor_cell = soup.select_one(
            'main div div div:nth-child(4) div div section:first-child div div table tbody tr td:nth-child(2)')

        if vendor_cell:
            return vendor_cell.text.strip()
        return None
    except (requests.RequestException, AttributeError) as e:
        print(f"Error fetching/parsing data: {e}")
        return None


if __name__ == '__main__':
    with open('vendor_mapping.json', 'r') as f:
        vendor_map = json.loads(f.read())

    for key, value in list(vendor_map.items()):
        if value is None: # vendor PEN was just added, so check the website
            vendor_name = fetch_vendor_info(key)
            if vendor_name:
                vendor_map[key] = vendor_name
                print(f"Updated {key} -> {vendor_name}")
            else: # faulty PEN, so delete the entry
                print(f"Failed to update {key}")
                vendor_map.pop(key)
                
    with open('unknown_vendors.json', 'w') as f:
        f.write(json.dumps(vendor_map, indent=2))